<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrenamiento Auditivo - @Andres_ChBFl</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14/build/Tone.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #0f0f1e;
      --card: #1a1a2e;
      --card-hover: #232340;
      --primary: #6c63ff;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --text: #e0e0e0;
      --text-muted: #a0a0a0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px 20px;
      background: linear-gradient(135deg, var(--primary), #9c5cff);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(108, 99, 255, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      color: white;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.1em;
    }

    .mobile-indicator {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      border-radius: 10px;
      margin-top: 15px;
      display: none;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    @media (max-width: 768px) {
      .mobile-indicator {
        display: block;
      }
      
      h1 {
        font-size: 1.8em;
      }
      
      header {
        padding: 20px 15px;
        margin-bottom: 20px;
      }
    }

    .study-item-card {
      background: var(--card-hover);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid rgba(108, 99, 255, 0.3);
    }

    .study-item-card:hover {
      transform: scale(1.05);
      border-color: var(--primary);
      box-shadow: 0 8px 20px rgba(108, 99, 255, 0.3);
    }

    .study-item-card:active {
      transform: scale(0.98);
    }

    .scale-visualization {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .scale-diagram {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    .scale-note {
      background: var(--primary);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: bold;
      position: relative;
      min-width: 45px;
      text-align: center;
    }

    .scale-interval {
      color: #666;
      font-size: 0.85em;
      font-weight: normal;
      padding: 0 8px;
    }

    .interval-whole {
      color: var(--success);
      font-weight: bold;
    }

    .interval-half {
      color: var(--danger);
      font-weight: bold;
    }

    .staff-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 15px;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .staff-lines {
      position: relative;
      width: 100%;
      max-width: 600px;
    }

    .mode-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .chat-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary), #9c5cff);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(108, 99, 255, 0.5);
      transition: all 0.3s;
      z-index: 1000;
      font-size: 1.8em;
    }

    .chat-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(108, 99, 255, 0.7);
    }

    .chat-container {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 400px;
      height: 600px;
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      display: none;
      flex-direction: column;
      z-index: 999;
      overflow: hidden;
    }

    .chat-container.open {
      display: flex;
    }

    .chat-header {
      background: linear-gradient(135deg, var(--primary), #9c5cff);
      padding: 20px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h3 {
      margin: 0;
      font-size: 1.2em;
    }

    .chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .chat-message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      animation: slideIn 0.3s;
    }

    .chat-message.user {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant {
      background: rgba(108, 99, 255, 0.1);
      color: var(--text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .chat-message.loading {
      background: rgba(108, 99, 255, 0.1);
      color: var(--text-muted);
      align-self: flex-start;
    }

    .chat-input-area {
      padding: 15px;
      border-top: 2px solid rgba(108, 99, 255, 0.3);
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      background: var(--card-hover);
      border: 2px solid rgba(108, 99, 255, 0.3);
      border-radius: 10px;
      padding: 12px;
      color: var(--text);
      font-size: 1em;
      resize: none;
      font-family: inherit;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chat-send {
      background: var(--primary);
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      color: white;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s;
    }

    .chat-send:hover {
      background: #9c5cff;
    }

    .chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chat-suggestions {
      padding: 10px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      border-bottom: 2px solid rgba(108, 99, 255, 0.3);
    }

    .suggestion-chip {
      background: rgba(108, 99, 255, 0.2);
      border: 1px solid rgba(108, 99, 255, 0.4);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .suggestion-chip:hover {
      background: var(--primary);
      color: white;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .chat-container {
        width: calc(100% - 40px);
        height: 500px;
        right: 20px;
        bottom: 90px;
      }
      
      .chat-button {
        right: 20px;
        bottom: 20px;
      }
    }

    .mode-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .mode-card {
      background: var(--card);
      padding: 25px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
      text-align: center;
    }

    .mode-card:hover {
      background: var(--card-hover);
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .mode-card.active {
      border-color: var(--primary);
      background: var(--card-hover);
      box-shadow: 0 0 20px rgba(108, 99, 255, 0.4);
    }

    .mode-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .mode-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .exercise-area {
      background: var(--card);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .settings-panel {
      background: rgba(108, 99, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .settings-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .toggle-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .toggle-btn {
      background: var(--card-hover);
      color: var(--text);
      border: 2px solid rgba(108, 99, 255, 0.3);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95em;
    }

    .toggle-btn:hover {
      border-color: var(--primary);
    }

    .toggle-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .progress-info {
      background: rgba(6, 214, 160, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      text-align: center;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--primary));
      transition: width 0.5s ease;
    }

    .unlock-message {
      color: var(--success);
      font-weight: bold;
      margin-top: 10px;
      animation: pulse 1s infinite;
    }

    .score-board {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(108, 99, 255, 0.1);
      border-radius: 15px;
    }

    .score-item {
      text-align: center;
    }

    .score-label {
      color: var(--text-muted);
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .score-value {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary);
    }

    .score-value.success { color: var(--success); }
    .score-value.danger { color: var(--danger); }

    .play-controls {
      text-align: center;
      margin: 30px 0;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.1em;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      margin: 5px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(108, 99, 255, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #000; }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }

    .option-btn {
      background: var(--card-hover);
      color: var(--text);
      border: 2px solid rgba(108, 99, 255, 0.3);
      padding: 20px;
      font-size: 1.1em;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .option-btn:hover:not(:disabled) {
      border-color: var(--primary);
      background: rgba(108, 99, 255, 0.2);
      transform: scale(1.05);
    }

    .option-btn.correct {
      background: var(--success);
      border-color: var(--success);
      color: white;
      animation: pulse 0.5s;
    }

    .option-btn.incorrect {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
      animation: shake 0.5s;
    }

    .option-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .option-btn.locked {
      opacity: 0.4;
      position: relative;
    }

    .option-btn.locked::after {
      content: 'üîí';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 0.8em;
    }

    .feedback {
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      margin: 20px 0;
      padding: 20px;
      border-radius: 10px;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .feedback.correct {
      background: rgba(6, 214, 160, 0.2);
      color: var(--success);
    }

    .feedback.incorrect {
      background: rgba(239, 71, 111, 0.2);
      color: var(--danger);
    }

    .start-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      text-align: center;
      padding: 20px;
    }

    .start-overlay h2 {
      font-size: 2.5em;
      margin-bottom: 20px;
      color: var(--primary);
    }

    .start-overlay p {
      font-size: 1.2em;
      margin-bottom: 30px;
      color: var(--text-muted);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.8em; }
      .mode-selector { grid-template-columns: 1fr; }
      .options-grid { grid-template-columns: 1fr; }
      .score-board { flex-direction: column; gap: 15px; }
      .toggle-group { justify-content: center; }
      
      .exercise-area {
        padding: 20px;
        margin-top: 20px;
      }
      
      .play-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .scale-diagram {
        flex-direction: column;
        gap: 5px;
      }
      
      .scale-interval {
        transform: rotate(90deg);
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <div id="startOverlay" class="start-overlay">
    <h2>üéµ Entrenamiento Auditivo Musical</h2>
    <p>Haz clic para activar el sonido y comenzar</p>
    <button class="btn btn-success" onclick="initAudio()">‚ñ∂ INICIAR</button>
  </div>

  <div class="container">
    <header>
      <h1>üéº Entrenamiento Auditivo Musical</h1>
      <p class="subtitle">por @Andres_ChBFl ‚Ä¢ Colombia ‚Ä¢ 2025</p>
      <div class="mobile-indicator">
        ‚¨áÔ∏è Desliza hacia abajo para comenzar los ejercicios
      </div>
    </header>

    <!-- Pesta√±as de Modo -->
    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
      <button class="btn btn-success" onclick="setViewMode('study')" id="studyModeBtn">
        üìö Modo Estudio
      </button>
      <button class="btn" onclick="setViewMode('test')" id="testModeBtn">
        ‚úèÔ∏è Modo Prueba
      </button>
    </div>

    <div class="mode-selector">
      <div class="mode-card active" onclick="setMode('intervalos')" data-mode="intervalos">
        <div class="mode-icon">üéµ</div>
        <div class="mode-title">Intervalos</div>
        <p>Ascendentes y Descendentes</p>
      </div>
      <div class="mode-card" onclick="setMode('triadas')" data-mode="triadas">
        <div class="mode-icon">üéπ</div>
        <div class="mode-title">Tr√≠adas</div>
        <p>Progresivo: 4 tipos b√°sicos</p>
      </div>
      <div class="mode-card" onclick="setMode('inversiones')" data-mode="inversiones">
        <div class="mode-icon">üîÑ</div>
        <div class="mode-title">Inversiones</div>
        <p>Fundamental, 1¬™ y 2¬™</p>
      </div>
      <div class="mode-card" onclick="setMode('septimas')" data-mode="septimas">
        <div class="mode-icon">7Ô∏è‚É£</div>
        <div class="mode-title">S√©ptimas</div>
        <p>Acordes de 4 notas</p>
      </div>
      <div class="mode-card" onclick="setMode('progresiones')" data-mode="progresiones">
        <div class="mode-icon">üéº</div>
        <div class="mode-title">Progresiones</div>
        <p>Secuencias de Acordes</p>
      </div>
      <div class="mode-card" onclick="setMode('escalas')" data-mode="escalas">
        <div class="mode-icon">üé∂</div>
        <div class="mode-title">Escalas</div>
        <p>Mayor, Menor y Modos</p>
      </div>
    </div>

    <div class="exercise-area">
      <!-- MODO ESTUDIO -->
      <div id="studyArea" style="display: none;">
        <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">
          üìö Modo Estudio - Explora y Aprende
        </h2>
        <p style="text-align: center; margin-bottom: 30px; color: var(--text-muted);">
          Haz clic en cada opci√≥n para escuchar y familiarizarte con los sonidos
        </p>
        <div id="studyContent" class="options-grid"></div>
      </div>

      <!-- MODO PRUEBA -->
      <div id="testArea">
        <!-- Panel de configuraci√≥n -->
        <div id="settingsPanel" class="settings-panel">
          <div class="settings-title">‚öôÔ∏è Configuraci√≥n</div>
          <div id="settingsContent"></div>
        </div>

      <div class="score-board">
        <div class="score-item">
          <div class="score-label">Correctas</div>
          <div class="score-value success" id="correctScore">0</div>
        </div>
        <div class="score-item">
          <div class="score-label">Incorrectas</div>
          <div class="score-value danger" id="incorrectScore">0</div>
        </div>
        <div class="score-item">
          <div class="score-label">Racha</div>
          <div class="score-value" id="streakScore">0</div>
        </div>
      </div>

      <div class="play-controls">
        <button class="btn" onclick="playSound()" id="playBtn">
          üîä Reproducir
        </button>
        <button class="btn btn-warning" onclick="nextQuestion()">
          üîÑ Siguiente
        </button>
        <button class="btn btn-danger" onclick="resetScore()">
          ‚Ü∫ Reiniciar Puntuaci√≥n
        </button>
      </div>

      <div id="optionsContainer" class="options-grid"></div>

      <div id="feedback" class="feedback"></div>
      </div>
    </div>

    <!-- FOOTER PROFESIONAL -->
    <footer style="text-align: center; padding: 40px 20px; margin-top: 60px; 
                   background: var(--card); border-radius: 20px; 
                   box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
      <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.8em;">
        üéì Proyecto de Investigaci√≥n Acad√©mica
      </h3>
      
      <div style="max-width: 800px; margin: 0 auto;">
        <p style="margin-bottom: 12px; font-size: 1.1em;">
          <strong style="color: var(--primary);">Desarrollado por:</strong> 
          <span style="color: var(--success);">Prof. Andr√©s Ch√°vez</span>
        </p>
        
        <p style="margin-bottom: 12px; font-size: 1.1em;">
          <strong style="color: var(--primary);">Instituci√≥n:</strong> 
          Universidad del Quind√≠o
        </p>
        
        <p style="margin-bottom: 12px; font-size: 1.1em;">
          <strong style="color: var(--primary);">Ubicaci√≥n:</strong> 
          Armenia, Quind√≠o, Colombia üá®üá¥
        </p>
        
        <p style="margin-bottom: 12px; font-size: 1.1em;">
          <strong style="color: var(--primary);">A√±o:</strong> 2025
        </p>
        
        <div style="margin: 30px 0; padding: 20px; 
                    background: rgba(108, 99, 255, 0.1); 
                    border-radius: 15px; border-left: 4px solid var(--primary);">
          <p style="color: var(--text); font-size: 1.05em; line-height: 1.8;">
            <strong>üìö Descripci√≥n del Proyecto:</strong><br>
            Herramienta digital interactiva para el desarrollo del o√≠do musical 
            y entrenamiento auditivo. Proyecto de innovaci√≥n pedag√≥gica que 
            integra tecnolog√≠a web y educaci√≥n musical para estudiantes 
            universitarios y p√∫blico general interesado en mejorar sus 
            habilidades auditivas musicales.
          </p>
        </div>
        
        <div style="margin: 25px 0;">
          <p style="color: var(--text-muted); font-size: 1em; line-height: 1.6;">
            <strong>üéØ √Åreas de aplicaci√≥n:</strong><br>
            Intervalos ‚Ä¢ Acordes ‚Ä¢ Inversiones ‚Ä¢ S√©ptimas ‚Ä¢ Progresiones ‚Ä¢ Escalas
          </p>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; 
                    border-top: 2px solid rgba(108, 99, 255, 0.3);">
          <p style="margin-bottom: 15px; font-size: 1em;">
            <strong style="color: var(--primary);">üìß Contacto:</strong> 
            <a href="mailto:archavez@uniquindio.edu.co" 
               style="color: var(--success); text-decoration: none;">
              archavez@uniquindio.edu.co
            </a>
          </p>
          
          <p style="color: var(--text-muted); font-size: 0.95em; margin-top: 20px;">
            ¬© 2025 Universidad del Quind√≠o - Todos los derechos reservados<br>
            Herramienta educativa de acceso libre para fines acad√©micos
          </p>
        </div>
        
        <div style="margin-top: 25px;">
          <p style="font-size: 0.9em; color: var(--text-muted);">
            <strong>Versi√≥n:</strong> 1.0 | 
            <strong>√öltima actualizaci√≥n:</strong> Noviembre 2025
          </p>
        </div>
      </div>
    </footer>
  </div>

  <!-- CHAT DE IA -->
  <div class="chat-button" onclick="toggleChat()" id="chatButton">
    üí¨
  </div>

  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <h3>üéµ Asistente Musical IA</h3>
      <button class="chat-close" onclick="toggleChat()">√ó</button>
    </div>
    
    <div class="chat-suggestions">
      <div class="suggestion-chip" onclick="askQuestion('¬øQu√© es un intervalo de tercera mayor?')">
        Tercera mayor
      </div>
      <div class="suggestion-chip" onclick="askQuestion('Explica las inversiones de acordes')">
        Inversiones
      </div>
      <div class="suggestion-chip" onclick="askQuestion('¬øC√≥mo reconocer un acorde menor?')">
        Acorde menor
      </div>
      <div class="suggestion-chip" onclick="askQuestion('¬øQu√© es una progresi√≥n arm√≥nica?')">
        Progresiones
      </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message assistant">
        ¬°Hola! Soy tu asistente de teor√≠a musical. Puedo ayudarte con:
        <br><br>
        ‚Ä¢ Intervalos y sus caracter√≠sticas<br>
        ‚Ä¢ Acordes (tr√≠adas y s√©ptimas)<br>
        ‚Ä¢ Inversiones de acordes<br>
        ‚Ä¢ Progresiones arm√≥nicas<br>
        ‚Ä¢ Escalas y modos<br>
        ‚Ä¢ Conceptos de solfeo y armon√≠a<br>
        <br>
        ¬øEn qu√© puedo ayudarte?
      </div>
    </div>
    
    <div class="chat-input-area">
      <textarea 
        class="chat-input" 
        id="chatInput" 
        placeholder="Pregunta sobre teor√≠a musical..."
        rows="1"
        onkeypress="handleChatKeyPress(event)"
      ></textarea>
      <button class="chat-send" onclick="sendMessage()" id="sendButton">
        ‚û§
      </button>
    </div>
  </div>

  <script>
    // ==================== CONFIGURACI√ìN ====================
    const synth = new Tone.PolySynth(Tone.Synth).toDestination();
    let audioReady = false;
    let currentMode = 'intervalos';
    let viewMode = 'study'; // 'study' o 'test'
    let currentQuestion = null;
    let answered = false;
    let chatHistory = [];
    
    const scores = {
      correct: 0,
      incorrect: 0,
      streak: 0
    };

    // Configuraci√≥n de intervalos
    const intervalSettings = {
      ascending: true,
      descending: false
    };

    // Progreso de tr√≠adas (sistema de desbloqueo)
    const triadasProgress = {
      correctAnswers: 0,
      unlockedChords: ['Mayor', 'Menor', 'Aumentado', 'Disminuido']
    };

    // Notas musicales
    const noteNames = ['Do', 'Do‚ôØ', 'Re', 'Re‚ôØ', 'Mi', 'Fa', 'Fa‚ôØ', 'Sol', 'Sol‚ôØ', 'La', 'La‚ôØ', 'Si'];
    
    // Informaci√≥n detallada de escalas
    const scaleDetails = {
      'Mayor': {
        pattern: ['T', 'T', 'st', 'T', 'T', 'T', 'st'],
        notes: ['Do', 'Re', 'Mi', 'Fa', 'Sol', 'La', 'Si', 'Do']
      },
      'Menor Natural': {
        pattern: ['T', 'st', 'T', 'T', 'st', 'T', 'T'],
        notes: ['La', 'Si', 'Do', 'Re', 'Mi', 'Fa', 'Sol', 'La']
      },
      'Menor Arm√≥nica': {
        pattern: ['T', 'st', 'T', 'T', 'st', 'T+st', 'st'],
        notes: ['La', 'Si', 'Do', 'Re', 'Mi', 'Fa', 'Sol‚ôØ', 'La']
      },
      'Menor Mel√≥dica': {
        pattern: ['T', 'st', 'T', 'T', 'T', 'T', 'st'],
        notes: ['La', 'Si', 'Do', 'Re', 'Mi', 'Fa‚ôØ', 'Sol‚ôØ', 'La']
      },
      'Pentat√≥nica Mayor': {
        pattern: ['T', 'T', 'T+st', 'T', 'T+st'],
        notes: ['Do', 'Re', 'Mi', 'Sol', 'La', 'Do']
      },
      'Pentat√≥nica Menor': {
        pattern: ['T+st', 'T', 'T', 'T+st', 'T'],
        notes: ['La', 'Do', 'Re', 'Mi', 'Sol', 'La']
      },
      'Blues': {
        pattern: ['T+st', 'T', 'st', 'st', 'T+st', 'T'],
        notes: ['La', 'Do', 'Re', 'Re‚ôØ', 'Mi', 'Sol', 'La']
      },
      'D√≥rica': {
        pattern: ['T', 'st', 'T', 'T', 'T', 'st', 'T'],
        notes: ['Re', 'Mi', 'Fa', 'Sol', 'La', 'Si', 'Do', 'Re']
      }
    };

    // ==================== DATOS MUSICALES ====================
    const musicData = {
      intervalos: [
        { name: 'Segunda menor (m2)', semitones: 1 },
        { name: 'Segunda mayor (M2)', semitones: 2 },
        { name: 'Tercera menor (m3)', semitones: 3 },
        { name: 'Tercera mayor (M3)', semitones: 4 },
        { name: 'Cuarta justa (P4)', semitones: 5 },
        { name: 'Tritono (TT)', semitones: 6 },
        { name: 'Quinta justa (P5)', semitones: 7 },
        { name: 'Sexta menor (m6)', semitones: 8 },
        { name: 'Sexta mayor (M6)', semitones: 9 },
        { name: 'S√©ptima menor (m7)', semitones: 10 },
        { name: 'S√©ptima mayor (M7)', semitones: 11 },
        { name: 'Octava (P8)', semitones: 12 }
      ],
      triadas: [
        { name: 'Mayor', intervals: [0, 4, 7], unlockAt: 0 },
        { name: 'Menor', intervals: [0, 3, 7], unlockAt: 0 },
        { name: 'Aumentado', intervals: [0, 4, 8], unlockAt: 0 },
        { name: 'Disminuido', intervals: [0, 3, 6], unlockAt: 0 },
        { name: 'Suspendido 2', intervals: [0, 2, 7], unlockAt: 10 },
        { name: 'Suspendido 4', intervals: [0, 5, 7], unlockAt: 15 },
        { name: 'Quinta (Power chord)', intervals: [0, 7, 12], unlockAt: 20 }
      ],
      inversiones: [
        { name: 'Mayor - Fundamental', intervals: [0, 4, 7], type: 'Mayor' },
        { name: 'Mayor - 1¬™ Inversi√≥n', intervals: [0, 3, 8], type: 'Mayor' },
        { name: 'Mayor - 2¬™ Inversi√≥n', intervals: [0, 5, 9], type: 'Mayor' },
        { name: 'Menor - Fundamental', intervals: [0, 3, 7], type: 'Menor' },
        { name: 'Menor - 1¬™ Inversi√≥n', intervals: [0, 4, 9], type: 'Menor' },
        { name: 'Menor - 2¬™ Inversi√≥n', intervals: [0, 5, 8], type: 'Menor' }
      ],
      septimas: [
        { name: 'Mayor 7', intervals: [0, 4, 7, 11] },
        { name: 'Menor 7', intervals: [0, 3, 7, 10] },
        { name: 'Dominante 7', intervals: [0, 4, 7, 10] },
        { name: 'Menor 7‚ô≠5', intervals: [0, 3, 6, 10] },
        { name: 'Mayor 7‚ôØ5', intervals: [0, 4, 8, 11] },
        { name: 'Disminuido 7', intervals: [0, 3, 6, 9] }
      ],
      progresiones: [
        { name: 'I - IV - V - I', chords: [[0,4,7], [5,9,12], [7,11,14], [0,4,7]] },
        { name: 'I - V - vi - IV', chords: [[0,4,7], [7,11,14], [9,12,16], [5,9,12]] },
        { name: 'ii - V - I', chords: [[2,5,9], [7,11,14], [0,4,7]] },
        { name: 'I - vi - IV - V', chords: [[0,4,7], [9,12,16], [5,9,12], [7,11,14]] },
        { name: 'vi - IV - I - V', chords: [[9,12,16], [5,9,12], [0,4,7], [7,11,14]] }
      ],
      escalas: [
        { name: 'Mayor', intervals: [0,2,4,5,7,9,11,12] },
        { name: 'Menor Natural', intervals: [0,2,3,5,7,8,10,12] },
        { name: 'Menor Arm√≥nica', intervals: [0,2,3,5,7,8,11,12] },
        { name: 'Menor Mel√≥dica', intervals: [0,2,3,5,7,9,11,12] },
        { name: 'Pentat√≥nica Mayor', intervals: [0,2,4,7,9,12] },
        { name: 'Pentat√≥nica Menor', intervals: [0,3,5,7,10,12] },
        { name: 'Blues', intervals: [0,3,5,6,7,10,12] },
        { name: 'D√≥rica', intervals: [0,2,3,5,7,9,10,12] }
      ]
    };

    // ==================== INICIALIZACI√ìN ====================
    async function initAudio() {
      await Tone.start();
      audioReady = true;
      document.getElementById('startOverlay').style.display = 'none';
      setViewMode('study'); // Empezar en modo estudio
      updateView();
    }

    // ==================== CHAT DE IA ====================
    function toggleChat() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.classList.toggle('open');
    }

    function handleChatKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function askQuestion(question) {
      document.getElementById('chatInput').value = question;
      sendMessage();
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Limpiar input
      input.value = '';
      
      // Agregar mensaje del usuario
      addMessageToChat('user', message);
      
      // Deshabilitar bot√≥n de env√≠o
      const sendButton = document.getElementById('sendButton');
      sendButton.disabled = true;
      
      // Mostrar mensaje de carga
      const loadingId = addMessageToChat('loading', 'üéº Pensando...');
      
      // Respuestas predefinidas del asistente de teor√≠a musical
      const response = getMusicTheoryResponse(message);
      
      // Simular un peque√±o delay para que se sienta m√°s natural
      setTimeout(() => {
        removeMessageFromChat(loadingId);
        addMessageToChat('assistant', response);
        chatHistory.push({ user: message, assistant: response });
        sendButton.disabled = false;
      }, 800);
    }

    function getMusicTheoryResponse(question) {
      const q = question.toLowerCase();
      
      // Intervalos
      if (q.includes('tercera mayor') || q.includes('3ra mayor') || q.includes('3m')) {
        return 'üéµ <strong>Tercera Mayor</strong><br><br>Es un intervalo de <strong>4 semitonos</strong> (2 tonos).<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido brillante y alegre<br>‚Ä¢ Base del acorde mayor<br>‚Ä¢ Ejemplo: Do-Mi, Sol-Si<br><br><strong>En la app:</strong> Encu√©ntralo en la secci√≥n de Intervalos. Su sonido es el inicio de "Oh When the Saints". üé∫';
      }
      
      if (q.includes('tercera menor') || q.includes('3ra menor')) {
        return 'üéµ <strong>Tercera Menor</strong><br><br>Es un intervalo de <strong>3 semitonos</strong> (1 tono + ¬Ω).<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido oscuro y melanc√≥lico<br>‚Ä¢ Base del acorde menor<br>‚Ä¢ Ejemplo: Do-Mib, La-Do<br><br><strong>En la app:</strong> Lo encontrar√°s en Intervalos. Aparece en "Greensleeves". üéº';
      }
      
      if (q.includes('quinta justa') || q.includes('5ta justa')) {
        return 'üéµ <strong>Quinta Justa</strong><br><br>Es un intervalo de <strong>7 semitonos</strong> (3 tonos + ¬Ω).<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ El m√°s consonante despu√©s de la octava<br>‚Ä¢ Base de todos los acordes<br>‚Ä¢ Sonido estable y fuerte<br>‚Ä¢ Ejemplo: Do-Sol, Re-La<br><br><strong>Referencia:</strong> Inicio de "Star Wars". ‚≠ê';
      }
      
      if (q.includes('tritono') || q.includes('cuarta aumentada')) {
        return 'üéµ <strong>Tritono</strong><br><br>Es un intervalo de <strong>6 semitonos</strong> (3 tonos exactos).<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ El m√°s disonante<br>‚Ä¢ Llamado "Diabolus in Musica" en la Edad Media<br>‚Ä¢ Divide la octava en dos partes iguales<br>‚Ä¢ Ejemplo: Do-Fa#, Si-Fa<br><br><strong>Lo escuchas en:</strong> Los Simpsons, Black Sabbath üé∏';
      }
      
      // Acordes
      if (q.includes('acorde mayor') || q.includes('triada mayor')) {
        return 'üéπ <strong>Acorde Mayor</strong><br><br><strong>Estructura:</strong> 1 - 3M - 5J<br>Intervalos: 0, 4, 7 semitonos<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido alegre y brillante<br>‚Ä¢ Estable y consonante<br>‚Ä¢ Ejemplo: Do mayor = Do-Mi-Sol<br><br><strong>En la app:</strong> Practica en "Tr√≠adas". Es uno de los 4 acordes b√°sicos. üéµ';
      }
      
      if (q.includes('acorde menor') || q.includes('triada menor')) {
        return 'üéπ <strong>Acorde Menor</strong><br><br><strong>Estructura:</strong> 1 - 3m - 5J<br>Intervalos: 0, 3, 7 semitonos<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido triste y melanc√≥lico<br>‚Ä¢ M√°s oscuro que el mayor<br>‚Ä¢ Ejemplo: La menor = La-Do-Mi<br><br><strong>Diferencia con mayor:</strong> Solo cambia la tercera (de 4 a 3 semitonos). üéº';
      }
      
      if (q.includes('aumentado')) {
        return 'üéπ <strong>Acorde Aumentado</strong><br><br><strong>Estructura:</strong> 1 - 3M - 5A<br>Intervalos: 0, 4, 8 semitonos<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido tenso e inestable<br>‚Ä¢ Sim√©trico (divide octava en 3 partes iguales)<br>‚Ä¢ Usado para crear tensi√≥n<br>‚Ä¢ Ejemplo: Do+ = Do-Mi-Sol#<br><br><strong>En la app:</strong> Disponible en "Tr√≠adas". ‚ú®';
      }
      
      if (q.includes('disminuido')) {
        return 'üéπ <strong>Acorde Disminuido</strong><br><br><strong>Estructura:</strong> 1 - 3m - 5d<br>Intervalos: 0, 3, 6 semitonos<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Muy tenso y disonante<br>‚Ä¢ Necesita resolver<br>‚Ä¢ Usado en transiciones<br>‚Ä¢ Ejemplo: Si¬∞ = Si-Re-Fa<br><br><strong>Tip:</strong> Dos terceras menores apiladas. üéµ';
      }
      
      // Inversiones
      if (q.includes('inversion') || q.includes('inversi√≥n')) {
        return 'üîÑ <strong>Inversiones de Acordes</strong><br><br><strong>Fundamental:</strong> Notas en orden 1-3-5<br>Ejemplo: Do-Mi-Sol<br><br><strong>1¬™ Inversi√≥n:</strong> La 3¬™ es el bajo<br>Ejemplo: Mi-Sol-Do<br><br><strong>2¬™ Inversi√≥n:</strong> La 5¬™ es el bajo<br>Ejemplo: Sol-Do-Mi<br><br><strong>En la app:</strong> Secci√≥n "Inversiones" tiene ejercicios espec√≠ficos de Mayor y Menor. üéπ';
      }
      
      // S√©ptimas
      if (q.includes('mayor 7') || q.includes('maj7')) {
        return '7Ô∏è‚É£ <strong>Acorde Mayor 7</strong><br><br><strong>Estructura:</strong> 1 - 3M - 5J - 7M<br>Intervalos: 0, 4, 7, 11 semitonos<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido sofisticado, jazz<br>‚Ä¢ Muy consonante<br>‚Ä¢ Ejemplo: Cmaj7 = Do-Mi-Sol-Si<br><br><strong>Uso:</strong> Jazz, bossa nova, baladas. üé∑';
      }
      
      if (q.includes('dominante 7') || q.includes('acorde 7') || (q.includes('septima') && q.includes('dominante'))) {
        return '7Ô∏è‚É£ <strong>Acorde Dominante 7</strong><br><br><strong>Estructura:</strong> 1 - 3M - 5J - 7m<br>Intervalos: 0, 4, 7, 10 semitonos<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Tenso, quiere resolver<br>‚Ä¢ Fundamental en blues y jazz<br>‚Ä¢ Ejemplo: C7 = Do-Mi-Sol-Sib<br><br><strong>Funci√≥n:</strong> Resolver a la t√≥nica (V7‚ÜíI). üé∏';
      }
      
      if (q.includes('menor 7') || q.includes('m7')) {
        return '7Ô∏è‚É£ <strong>Acorde Menor 7</strong><br><br><strong>Estructura:</strong> 1 - 3m - 5J - 7m<br>Intervalos: 0, 3, 7, 10 semitonos<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido suave y melanc√≥lico<br>‚Ä¢ Muy usado en jazz y R&B<br>‚Ä¢ Ejemplo: Dm7 = Re-Fa-La-Do<br><br><strong>Uso com√∫n:</strong> Funci√≥n de ii en ii-V-I. üéπ';
      }
      
      // Progresiones
      if (q.includes('progresion') || q.includes('progresi√≥n')) {
        return 'üéº <strong>Progresiones Arm√≥nicas</strong><br><br>Son secuencias de acordes que crean movimiento musical.<br><br><strong>Ejemplos en la app:</strong><br><br>‚Ä¢ <strong>I-IV-V-I:</strong> Cl√°sica, rock b√°sico<br>‚Ä¢ <strong>I-V-vi-IV:</strong> Pop moderno ("Let It Be")<br>‚Ä¢ <strong>ii-V-I:</strong> Jazz est√°ndar<br><br><strong>En n√∫meros romanos:</strong><br>I = t√≥nica, ii = supert√≥nica, V = dominante, etc. üéµ';
      }
      
      // Escalas
      if (q.includes('escala mayor')) {
        return 'üé∂ <strong>Escala Mayor</strong><br><br><strong>Patr√≥n:</strong> T - T - st - T - T - T - st<br><br><strong>Ejemplo Do Mayor:</strong><br>Do-Re-Mi-Fa-Sol-La-Si-Do<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido alegre y brillante<br>‚Ä¢ Base de la m√∫sica occidental<br>‚Ä¢ 7 notas + octava<br><br><strong>En la app:</strong> Modo Estudio muestra los intervalos visualmente. üéµ';
      }
      
      if (q.includes('escala menor') || q.includes('menor natural')) {
        return 'üé∂ <strong>Escala Menor Natural</strong><br><br><strong>Patr√≥n:</strong> T - st - T - T - st - T - T<br><br><strong>Ejemplo La menor:</strong><br>La-Si-Do-Re-Mi-Fa-Sol-La<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sonido triste y oscuro<br>‚Ä¢ Relativa menor de Do Mayor<br>‚Ä¢ Mismas notas, diferente centro tonal<br><br><strong>Relaci√≥n:</strong> Comienza en el 6¬∫ grado de su mayor relativa. üéº';
      }
      
      if (q.includes('armonica') || q.includes('arm√≥nica')) {
        return 'üé∂ <strong>Escala Menor Arm√≥nica</strong><br><br><strong>Patr√≥n:</strong> T - st - T - T - st - T+st - st<br><br><strong>Ejemplo:</strong><br>La-Si-Do-Re-Mi-Fa-Sol#-La<br><br><strong>Diferencia con natural:</strong><br>La 7¬™ est√° elevada medio tono (Sol# en vez de Sol).<br><br><strong>Sonido:</strong> Ex√≥tico, usado en m√∫sica cl√°sica, flamenca y metal. üé∏';
      }
      
      if (q.includes('pentatonica') || q.includes('pentat√≥nica')) {
        return 'üé∂ <strong>Escalas Pentat√≥nicas</strong><br><br><strong>5 notas (sin st):</strong><br><br><strong>Mayor:</strong> 1-2-3-5-6<br>Do-Re-Mi-Sol-La<br><br><strong>Menor:</strong> 1-b3-4-5-b7<br>La-Do-Re-Mi-Sol<br><br><strong>Caracter√≠sticas:</strong><br>‚Ä¢ Sin disonancias<br>‚Ä¢ Muy usadas en rock, blues, folk<br>‚Ä¢ F√°ciles de improvisar<br><br><strong>Ejemplos:</strong> Solos de guitarra, m√∫sica asi√°tica. üé∏';
      }
      
      // Preguntas generales
      if (q.includes('intervalo')) {
        return 'üéµ <strong>¬øQu√© es un Intervalo?</strong><br><br>Es la distancia entre dos notas musicales.<br><br><strong>Se miden en:</strong><br>‚Ä¢ Semitonos (la m√≠nima distancia)<br>‚Ä¢ Tonos (2 semitonos)<br><br><strong>Tipos en la app:</strong><br>‚Ä¢ Mel√≥dicos: notas sucesivas<br>‚Ä¢ Arm√≥nicos: notas simult√°neas<br><br><strong>12 intervalos:</strong> Desde 2¬™ menor hasta octava. üéº';
      }
      
      if (q.includes('tono') && q.includes('semitono')) {
        return 'üéµ <strong>Tonos y Semitonos</strong><br><br><strong>Semitono (st):</strong><br>‚Ä¢ La distancia m√°s peque√±a<br>‚Ä¢ Ejemplo: Do‚ÜíDo# o Mi‚ÜíFa<br><br><strong>Tono (T):</strong><br>‚Ä¢ 2 semitonos<br>‚Ä¢ Ejemplo: Do‚ÜíRe o Mi‚ÜíFa#<br><br><strong>En el piano:</strong><br>‚Ä¢ Semitono = tecla siguiente<br>‚Ä¢ Tono = saltar una tecla<br><br>Son la base para construir escalas y acordes. üéπ';
      }
      
      if (q.includes('como') && (q.includes('estudi') || q.includes('practi') || q.includes('mejor'))) {
        return 'üìö <strong>Consejos para Estudiar</strong><br><br><strong>1. Modo Estudio:</strong><br>‚Ä¢ Familiar√≠zate con cada sonido<br>‚Ä¢ Escucha varias veces<br><br><strong>2. Modo Prueba:</strong><br>‚Ä¢ Empieza con pocos elementos<br>‚Ä¢ Aumenta dificultad gradualmente<br><br><strong>3. Pr√°ctica diaria:</strong><br>‚Ä¢ 15-20 min es suficiente<br>‚Ä¢ Constancia > Cantidad<br><br><strong>4. Visualiza + Escucha</strong><br>‚Ä¢ Usa las escalas visuales<br>‚Ä¢ Canta los intervalos<br><br>¬°La repetici√≥n es clave! üéØ';
      }
      
      // Respuesta por defecto
      return 'üéµ <strong>Pregunta sobre teor√≠a musical</strong><br><br>Puedo ayudarte con:<br><br>‚Ä¢ <strong>Intervalos:</strong> "¬øQu√© es una tercera mayor?"<br>‚Ä¢ <strong>Acordes:</strong> "Explica el acorde aumentado"<br>‚Ä¢ <strong>Inversiones:</strong> "¬øQu√© es la primera inversi√≥n?"<br>‚Ä¢ <strong>S√©ptimas:</strong> "Diferencia entre Maj7 y 7"<br>‚Ä¢ <strong>Progresiones:</strong> "¬øQu√© es I-IV-V?"<br>‚Ä¢ <strong>Escalas:</strong> "Explica la escala menor arm√≥nica"<br><br>Haz tu pregunta sobre teor√≠a musical. üéº';
    }

    function addMessageToChat(type, content) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      const messageId = 'msg-' + Date.now();
      
      messageDiv.className = `chat-message ${type}`;
      messageDiv.id = messageId;
      messageDiv.innerHTML = content.replace(/\n/g, '<br>');
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      return messageId;
    }

    function removeMessageFromChat(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // ==================== CAMBIO DE VISTA ====================
    function setViewMode(mode) {
      viewMode = mode;
      
      // Actualizar botones
      document.getElementById('studyModeBtn').className = mode === 'study' ? 'btn btn-success' : 'btn';
      document.getElementById('testModeBtn').className = mode === 'test' ? 'btn btn-success' : 'btn';
      
      updateView();
    }

    function updateView() {
      const studyArea = document.getElementById('studyArea');
      const testArea = document.getElementById('testArea');
      
      if (viewMode === 'study') {
        studyArea.style.display = 'block';
        testArea.style.display = 'none';
        renderStudyMode();
      } else {
        studyArea.style.display = 'none';
        testArea.style.display = 'block';
        updateSettingsPanel();
        nextQuestion();
      }
    }

    // ==================== MODO ESTUDIO ====================
    function renderStudyMode() {
      const container = document.getElementById('studyContent');
      container.innerHTML = '';
      
      let items = [];
      
      if (currentMode === 'intervalos') {
        items = musicData.intervalos.map(item => ({
          ...item,
          description: `${item.name} - ${item.semitones} semitonos`
        }));
      } else if (currentMode === 'triadas') {
        items = musicData.triadas.map(item => ({
          ...item,
          description: item.name
        }));
      } else if (currentMode === 'inversiones') {
        items = musicData.inversiones.map(item => ({
          ...item,
          description: item.name
        }));
      } else if (currentMode === 'septimas') {
        items = musicData.septimas.map(item => ({
          ...item,
          description: item.name
        }));
      } else if (currentMode === 'progresiones') {
        items = musicData.progresiones.map(item => ({
          ...item,
          description: item.name
        }));
      } else if (currentMode === 'escalas') {
        items = musicData.escalas.map(item => ({
          ...item,
          description: `${item.name} - ${item.desc || ''}`
        }));
      }
      
      items.forEach((item, index) => {
        const card = document.createElement('div');
        card.style.background = 'var(--card-hover)';
        card.style.padding = '25px';
        card.style.borderRadius = '12px';
        card.style.border = '2px solid rgba(108, 99, 255, 0.3)';
        card.style.cursor = 'pointer';
        card.style.transition = 'all 0.3s';
        
        card.onmouseover = () => {
          card.style.transform = 'scale(1.02)';
          card.style.borderColor = 'var(--primary)';
          card.style.boxShadow = '0 8px 20px rgba(108, 99, 255, 0.3)';
        };
        
        card.onmouseout = () => {
          card.style.transform = 'scale(1)';
          card.style.borderColor = 'rgba(108, 99, 255, 0.3)';
          card.style.boxShadow = 'none';
        };
        
        let cardContent = `
          <div style="font-size: 1.2em; margin-bottom: 8px; font-weight: bold; color: var(--primary);">
            ${item.description || item.name}
          </div>
          <div style="font-size: 2em; margin: 15px 0;">üîä</div>
        `;
        
        // Agregar visualizaci√≥n especial para escalas
        if (currentMode === 'escalas' && scaleDetails[item.name]) {
          const details = scaleDetails[item.name];
          
          cardContent += `
            <div class="scale-visualization">
              <div class="scale-diagram">
                ${details.notes.map((note, i) => {
                  let intervalText = '';
                  if (i < details.pattern.length) {
                    const pattern = details.pattern[i];
                    if (pattern === 'T') {
                      intervalText = '<span class="scale-interval interval-whole">‚Üí Tono ‚Üí</span>';
                    } else if (pattern === 'st') {
                      intervalText = '<span class="scale-interval interval-half">‚Üí ¬Ω ‚Üí</span>';
                    } else if (pattern === 'T+st') {
                      intervalText = '<span class="scale-interval interval-whole">‚Üí Tono+¬Ω ‚Üí</span>';
                    }
                  }
                  return `
                    <div class="scale-note">${note}</div>
                    ${intervalText}
                  `;
                }).join('')}
              </div>
              <div style="margin-top: 15px; padding: 10px; background: rgba(108, 99, 255, 0.1); border-radius: 8px;">
                <small style="color: #666;">
                  <span class="interval-whole">T = Tono completo (2 semitonos)</span> ‚Ä¢ 
                  <span class="interval-half">¬Ω = Semitono (1 semitono)</span>
                </small>
              </div>
            </div>
          `;
        }
        
        card.innerHTML = cardContent;
        card.onclick = () => playStudyItem(item);
        container.appendChild(card);
      });
    }

    function playStudyItem(item) {
      if (!audioReady) return;
      
      const now = Tone.now();
      
      if (currentMode === 'intervalos') {
        // Tocar ascendente y descendente
        synth.triggerAttackRelease(getFrequency(0), '0.5', now);
        synth.triggerAttackRelease(getFrequency(item.semitones), '0.5', now + 0.6);
        
        // Descendente despu√©s de una pausa
        synth.triggerAttackRelease(getFrequency(item.semitones), '0.5', now + 1.5);
        synth.triggerAttackRelease(getFrequency(0), '0.5', now + 2.1);
        
      } else if (currentMode === 'triadas' || currentMode === 'inversiones' || currentMode === 'septimas') {
        // Primero arm√≥nico
        const notes = item.intervals.map(i => getFrequency(i));
        notes.forEach(freq => {
          synth.triggerAttackRelease(freq, '1.5', now);
        });
        
        // Luego mel√≥dico (arpegio)
        notes.forEach((freq, i) => {
          synth.triggerAttackRelease(freq, '0.4', now + 2 + i * 0.3);
        });
        
      } else if (currentMode === 'progresiones') {
        item.chords.forEach((chord, i) => {
          const notes = chord.map(semi => getFrequency(semi));
          notes.forEach(freq => {
            synth.triggerAttackRelease(freq, '0.8', now + i * 1);
          });
        });
        
      } else if (currentMode === 'escalas') {
        // Ascendente
        item.intervals.forEach((semi, i) => {
          synth.triggerAttackRelease(getFrequency(semi), '0.3', now + i * 0.25);
        });
        
        // Descendente
        const reversed = [...item.intervals].reverse();
        reversed.forEach((semi, i) => {
          synth.triggerAttackRelease(getFrequency(semi), '0.3', now + item.intervals.length * 0.25 + 0.3 + i * 0.25);
        });
      }
    }

    // ==================== PANEL DE CONFIGURACI√ìN ====================
    function updateSettingsPanel() {
      const panel = document.getElementById('settingsContent');
      
      if (currentMode === 'intervalos') {
        panel.innerHTML = `
          <div>
            <strong>Direcci√≥n del intervalo:</strong>
            <div class="toggle-group">
              <button class="toggle-btn ${intervalSettings.ascending ? 'active' : ''}" 
                onclick="toggleIntervalSetting('ascending')">
                ‚Üë Ascendente
              </button>
              <button class="toggle-btn ${intervalSettings.descending ? 'active' : ''}" 
                onclick="toggleIntervalSetting('descending')">
                ‚Üì Descendente
              </button>
            </div>
          </div>
        `;
      } else if (currentMode === 'triadas') {
        const progress = triadasProgress.correctAnswers;
        const nextUnlock = musicData.triadas.find(c => c.unlockAt > progress);
        const progressPercent = nextUnlock ? (progress / nextUnlock.unlockAt * 100) : 100;
        
        panel.innerHTML = `
          <div class="progress-info">
            <strong>üéØ Progreso de Desbloqueo</strong>
            <p>Respuestas correctas: ${progress}</p>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            ${nextUnlock ? 
              `<p>Pr√≥ximo acorde: <strong>${nextUnlock.name}</strong> (${nextUnlock.unlockAt} correctas)</p>` :
              `<p class="unlock-message">‚ú® ¬°Todos los acordes desbloqueados!</p>`
            }
            <p style="margin-top: 10px; font-size: 0.9em; color: var(--text-muted);">
              Desbloqueados: ${triadasProgress.unlockedChords.join(', ')}
            </p>
          </div>
        `;
      } else {
        panel.innerHTML = '<p>Selecciona tu respuesta despu√©s de escuchar el sonido.</p>';
      }
    }

    function toggleIntervalSetting(setting) {
      intervalSettings[setting] = !intervalSettings[setting];
      
      // Al menos uno debe estar activo
      if (!intervalSettings.ascending && !intervalSettings.descending) {
        intervalSettings[setting] = true;
      }
      
      updateSettingsPanel();
      nextQuestion();
    }

    // ==================== FUNCIONES DE SONIDO ====================
    function getFrequency(semitones) {
      const baseFreq = 261.63; // C4
      return baseFreq * Math.pow(2, semitones / 12);
    }

    async function playSound() {
      if (!audioReady || !currentQuestion) return;
      
      const now = Tone.now();
      
      if (currentMode === 'intervalos') {
        const isDescending = currentQuestion.direction === 'descending';
        if (isDescending) {
          synth.triggerAttackRelease(getFrequency(currentQuestion.semitones), '0.5', now);
          synth.triggerAttackRelease(getFrequency(0), '0.5', now + 0.6);
        } else {
          synth.triggerAttackRelease(getFrequency(0), '0.5', now);
          synth.triggerAttackRelease(getFrequency(currentQuestion.semitones), '0.5', now + 0.6);
        }
      } 
      else if (currentMode === 'triadas' || currentMode === 'inversiones' || currentMode === 'septimas') {
        const notes = currentQuestion.intervals.map(i => getFrequency(i));
        notes.forEach(freq => {
          synth.triggerAttackRelease(freq, '1.5', now);
        });
      }
      else if (currentMode === 'progresiones') {
        currentQuestion.chords.forEach((chord, i) => {
          const notes = chord.map(semi => getFrequency(semi));
          notes.forEach(freq => {
            synth.triggerAttackRelease(freq, '0.8', now + i * 1);
          });
        });
      }
      else if (currentMode === 'escalas') {
        currentQuestion.intervals.forEach((semi, i) => {
          synth.triggerAttackRelease(getFrequency(semi), '0.3', now + i * 0.25);
        });
      }
    }

    // ==================== MANEJO DE MODOS ====================
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-card').forEach(card => {
        card.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
      updateView();
    }

    // ==================== GENERACI√ìN DE PREGUNTAS ====================
    function nextQuestion() {
      let options = [];
      let correctIndex = 0;

      if (currentMode === 'intervalos') {
        // Generar pregunta de intervalo
        options = musicData.intervalos;
        correctIndex = Math.floor(Math.random() * options.length);
        currentQuestion = {...options[correctIndex]};
        
        // Determinar direcci√≥n
        const directions = [];
        if (intervalSettings.ascending) directions.push('ascending');
        if (intervalSettings.descending) directions.push('descending');
        currentQuestion.direction = directions[Math.floor(Math.random() * directions.length)];
        
      } else if (currentMode === 'triadas') {
        // Solo mostrar acordes desbloqueados
        options = musicData.triadas.filter(chord => 
          triadasProgress.unlockedChords.includes(chord.name)
        );
        correctIndex = Math.floor(Math.random() * options.length);
        currentQuestion = options[correctIndex];
        
      } else {
        options = musicData[currentMode];
        correctIndex = Math.floor(Math.random() * options.length);
        currentQuestion = options[correctIndex];
      }
      
      answered = false;
      document.getElementById('feedback').textContent = '';
      document.getElementById('feedback').className = 'feedback';
      
      renderOptions(options, correctIndex);
      setTimeout(() => playSound(), 300);
    }

    function renderOptions(options, correctIndex) {
      const container = document.getElementById('optionsContainer');
      container.innerHTML = '';
      
      // Si es modo tr√≠adas, mostrar todos los acordes (bloqueados y desbloqueados)
      if (currentMode === 'triadas') {
        musicData.triadas.forEach((option, index) => {
          const btn = document.createElement('button');
          btn.className = 'option-btn';
          
          const isUnlocked = triadasProgress.unlockedChords.includes(option.name);
          const isInCurrentOptions = options.some(o => o.name === option.name);
          
          if (!isUnlocked) {
            btn.classList.add('locked');
            btn.disabled = true;
            btn.textContent = `${option.name} (${option.unlockAt} correctas)`;
          } else {
            btn.textContent = option.name;
            if (isInCurrentOptions && option.name === currentQuestion.name) {
              btn.onclick = () => checkAnswer(index, index, btn);
            } else if (isInCurrentOptions) {
              const actualIndex = options.findIndex(o => o.name === option.name);
              btn.onclick = () => checkAnswer(actualIndex, options.findIndex(o => o.name === currentQuestion.name), btn);
            }
          }
          
          container.appendChild(btn);
        });
      } else {
        options.forEach((option, index) => {
          const btn = document.createElement('button');
          btn.className = 'option-btn';
          btn.textContent = option.name;
          btn.onclick = () => checkAnswer(index, correctIndex, btn);
          container.appendChild(btn);
        });
      }
    }

    // ==================== VERIFICACI√ìN DE RESPUESTA ====================
    function checkAnswer(selectedIndex, correctIndex, btn) {
      if (answered) return;
      answered = true;
      
      const buttons = document.querySelectorAll('.option-btn:not(.locked)');
      buttons.forEach(b => b.disabled = true);
      
      const feedback = document.getElementById('feedback');
      
      if (selectedIndex === correctIndex) {
        btn.classList.add('correct');
        feedback.textContent = '¬°Correcto! ‚úì';
        feedback.className = 'feedback correct';
        scores.correct++;
        scores.streak++;
        
        // Sistema de desbloqueo para tr√≠adas
        if (currentMode === 'triadas') {
          triadasProgress.correctAnswers++;
          
          // Verificar si se desbloquea un nuevo acorde
          musicData.triadas.forEach(chord => {
            if (chord.unlockAt === triadasProgress.correctAnswers && 
                !triadasProgress.unlockedChords.includes(chord.name)) {
              triadasProgress.unlockedChords.push(chord.name);
              feedback.textContent += ` üéâ ¬°Nuevo acorde desbloqueado: ${chord.name}!`;
            }
          });
          
          updateSettingsPanel();
        }
        
      } else {
        btn.classList.add('incorrect');
        const allButtons = Array.from(document.querySelectorAll('.option-btn'));
        
        if (currentMode === 'triadas') {
          // Buscar el bot√≥n correcto por nombre
          const correctBtn = allButtons.find(b => 
            b.textContent === currentQuestion.name
          );
          if (correctBtn) correctBtn.classList.add('correct');
        } else {
          allButtons[correctIndex].classList.add('correct');
        }
        
        feedback.textContent = `Incorrecto. Era: ${currentQuestion.name}`;
        feedback.className = 'feedback incorrect';
        scores.incorrect++;
        scores.streak = 0;
      }
      
      updateScoreboard();
      
      // Auto-avanzar despu√©s de 2.5 segundos
      setTimeout(() => nextQuestion(), 2500);
    }

    // ==================== PUNTUACI√ìN ====================
    function updateScoreboard() {
      document.getElementById('correctScore').textContent = scores.correct;
      document.getElementById('incorrectScore').textContent = scores.incorrect;
      document.getElementById('streakScore').textContent = scores.streak;
    }

    function resetScore() {
      scores.correct = 0;
      scores.incorrect = 0;
      scores.streak = 0;
      
      // Reiniciar progreso de tr√≠adas
      if (currentMode === 'triadas') {
        triadasProgress.correctAnswers = 0;
        triadasProgress.unlockedChords = ['Mayor', 'Menor', 'Aumentado', 'Disminuido'];
        updateSettingsPanel();
      }
      
      updateScoreboard();
      nextQuestion();
    }
  </script>
</body>
</html>


